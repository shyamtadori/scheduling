<div class="row form-group">
  <div class="col-sm-2">
    <%= select_tag(:org_unit, options_for_select( Organization.all.map{|o| [o.company, o.org_unit.to_i]},:selected => @organization.id),{class: "form-control"})%>
  </div>
  <div class="col-sm-2">
    <%= select_tag(:base, options_for_select( @organization.bases.map{|b| [b.location_name, b.location_idx.to_i]},:selected => (@base.id if @base)),{class: "form-control"})%>
  </div>
  <div class="col-sm-2">
    <div class="input-group date" id='scheduling_month_dp'>
      <input class="form-control" id="scheduling_month_selector" type="text" name="scheduling_month" value="<%=@month%>-<%=@year%>" onkeydown="return false">
      <span class="input-group-addon">
        <i class="fa fa-calendar" id='scheduling_month_selector_icon' aria-hidden="true"></i>
      </span>
    </div>  
  </div>
</div>

<table class="table table-striped table-bordered monthly_schedule" id='monthly_schedule'>
  <thead>
    <tr>
      <th><%= @start_date.strftime('%B') %> - <%= @start_date.strftime('%Y') %> > <br> Jobs <i class="fa fa-fw fa-arrow-down"></i></th>
      <%= render('month_dates')%>
    </tr>
  </thead>
  <tbody>
    <%= render('jobs', :no_of_days => @no_of_days)%>
  </tbody>
</table>

<!-- Modal -->
<div class="modal fade" id="choose-pilot-modal" role="dialog">
  <div class="modal-dialog modal-lg">
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">Ã—</span></button>
        <h4 class="modal-title"></h4>
      </div>
      <div class="modal-body" id='form-div'>
        <!-- Form will render here -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
  $(document).ready(function() {
    $('#monthly_schedule').DataTable({
      scrollX: true,
      scrollY: $(window).height()- 195,
      paging: false,
      bSort: false,
      fixedColumns: true
    });
    //don't want to show number of records footer
    $('#monthly_schedule_info').html('');
    $("#monthly_schedule").on("click", "td", function() {
      var job_id = $(this).attr("data-job");
      var job_name = $(this).attr("data-jobname");
      var date = $(this).attr("data-date");
      params_data = {job_id: job_id, date: date};
      $.ajax({
        type: "GET",
        url: "/users/available_pilots.js",
        data: params_data,
        beforeSend: function() {
          $('.modal-title').text('Choose Pilot for Job: ' + job_name + ', Date: ' + date);
          $('#choose-pilot-modal').modal('show').find('.modal-body').html('Loading...');
        },
        error: function() {
          $('#choose-pilot-modal').modal('show').find('.modal-body').html('Error while loading pilots. Please refresh the page.');
        },
        // success: function(resp) {
        //   $('#choose-pilot-modal').modal('show').find('.modal-body').html('Available Users : '+resp.users.length);
        // }
      });
   });
  });

  window.onload = function() {
    var tables = $.fn.dataTable.tables(true);
    $( tables ).DataTable().columns.adjust();
  };
</script>

<script>
  $(function(){
    $("#scheduling_month_selector").datetimepicker({
      format: 'MM-YYYY'
    });
    $('#scheduling_month_selector_icon').click(function(e){
      e.preventDefault();
      $('#scheduling_month_selector').focus();
    });
    $('#scheduling_month_selector').on('dp.change', function(e){
      var selected_month_and_year = e.date.format(e.date._f);
      var selected_month = selected_month_and_year.split("-")[0];
      var selected_year = selected_month_and_year.split("-")[1];
      console.log(selected_month);
      console.log(selected_year);
      change_schedule_view(selected_month, selected_year);
    });
  });

  var change_schedule_view = function(selected_month, selected_year) {
    window.location.href = '/schedules/'+selected_month+'/'+selected_year;
  };
</script>
